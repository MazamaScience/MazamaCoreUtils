<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cache Management • MazamaCoreUtils</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Cache Management">
<meta property="og:description" content="MazamaCoreUtils">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MazamaCoreUtils</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.4.16</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MazamaScience/MazamaCoreUtils/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Cache Management</h1>
                        <h4 data-toc-skip class="author">Thomas
Bergamaschi</h4>
            
            <h4 data-toc-skip class="date">2018-10-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MazamaScience/MazamaCoreUtils/blob/HEAD/vignettes/cache-management.Rmd" class="external-link"><code>vignettes/cache-management.Rmd</code></a></small>
      <div class="hidden name"><code>cache-management.Rmd</code></div>

    </div>

    
    
<p>When building a web service, it is desirable to save commonly
requested products in a cache directory to avoid time wasted reproducing
them unnecessarily. Because the cache has finite disk space allocated to
it, the cache should be routinely purged of old or outdated files to
make room new ones. The <code><a href="../reference/manageCache.html">manageCache()</a></code> utility function
simplifies this process.</p>
<div class="section level2">
<h2 id="a-product-cache-example">A Product Cache Example<a class="anchor" aria-label="anchor" href="#a-product-cache-example"></a>
</h2>
<p>Lets first make a cache directory and put some data products in
it.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a cache directory</span></span>
<span><span class="va">CACHE_DIR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">'cache'</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">CACHE_DIR</span><span class="op">)</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">CACHE_DIR</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Add a few files to the cache</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">400</span>,<span class="fl">500</span><span class="op">)</span>, file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">CACHE_DIR</span>,<span class="st">'m1.csv'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="co"># wait a bit between each to give them different mtimes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">400</span>,<span class="fl">500</span><span class="op">)</span>, file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">CACHE_DIR</span>,<span class="st">'m2.csv'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">400</span>,<span class="fl">500</span><span class="op">)</span>, file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">CACHE_DIR</span>,<span class="st">'m3.csv'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">400</span>,<span class="fl">500</span><span class="op">)</span>, file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">CACHE_DIR</span>,<span class="st">'m4.csv'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can look in our new cache directory and see the four files we just
added. The directory contains about 1.5 MB of data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cachedFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">CACHE_DIR</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">infoDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.info</a></span><span class="op">(</span><span class="va">cachedFiles</span><span class="op">)</span></span>
<span><span class="va">cacheSize</span> <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">infoDF</span><span class="op">$</span><span class="va">size</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1e6</span><span class="op">)</span> <span class="co"># in MB</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">CACHE_DIR</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "m1.csv" "m2.csv" "m3.csv" "m4.csv"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Cache size = %s MB"</span>, <span class="va">cacheSize</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Cache size = 1.622748 MB"</span></span></code></pre></div>
<p>In order to simulate file requests, lets read two of them to update
their access time.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Access two of the files, updating their atime</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">CACHE_DIR</span>, <span class="st">'m1.csv'</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">CACHE_DIR</span>, <span class="st">'m2.csv'</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p>Now, lets use <code><a href="../reference/manageCache.html">manageCache()</a></code> to get our cache down to 1
MB.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use manageCache() to get cache to 1 MB</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/MazamaScience/MazamaCoreUtils" class="external-link">MazamaCoreUtils</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/manageCache.html">manageCache</a></span><span class="op">(</span><span class="va">CACHE_DIR</span>, extensions <span class="op">=</span> <span class="st">'csv'</span>, maxCacheSize <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>When we check our cache again, we will see that the two files with
the oldest access times are gone and the cache size is now under 1
MB.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check cache contents and total size again</span></span>
<span><span class="va">cachedFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">CACHE_DIR</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">infoDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.info</a></span><span class="op">(</span><span class="va">cachedFiles</span><span class="op">)</span></span>
<span><span class="va">cacheSize</span> <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">infoDF</span><span class="op">$</span><span class="va">size</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1e6</span><span class="op">)</span> <span class="co"># in MB</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">CACHE_DIR</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "m1.csv" "m2.csv"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Cache size = %s MB"</span>, <span class="va">cacheSize</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Cache size = 0.811374 MB"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="removing-stale-products">Removing ‘Stale’ Products<a class="anchor" aria-label="anchor" href="#removing-stale-products"></a>
</h2>
<p>Web services that provide access to real-time data often generate
products that have an expiration date. Files older than a specific
number of days or hours should be removed from the cache because they no
longer represent the current status.</p>
<p>Removing stale files can also help to keep the cache much smaller
than the absolute maximum cache size, enhancing overall performance.</p>
<p>Stale files – files that haven’t been modified in a while – can be
removed regardless of cache size with the <code>maxFileAge</code>
parameter. When this is set, files with an <code>mtime</code> older than
<code>maxFileAge</code> will be removed before any test of the
<code>maxCacheSize</code>. Fractional days are allowed.</p>
<p>You can remove standard products in the cache that haven’t been
modified in the last 3 hours with:</p>
<pre><code><span><span class="fu"><a href="../reference/manageCache.html">manageCache</a></span><span class="op">(</span><span class="va">CACHE_DIR</span>, maxFileAge <span class="op">=</span> <span class="fl">3</span><span class="op">/</span><span class="fl">24</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="other-use-cases">Other Use Cases<a class="anchor" aria-label="anchor" href="#other-use-cases"></a>
</h2>
<p>In the case of a product cache, the most typical behavior will be to
sort files based on last access time. The <code><a href="../reference/manageCache.html">manageCache()</a></code>
function uses <code>sortBy = "atime"</code> as the default. It is also
possible to sort based on modification time <code>mtime</code> or change
time <code>ctime</code>.</p>
<p>The use case scenario for <code>sortBy = "mtime"</code> might involve
files that are considered <em>stale</em> if the contents aren’t
updated.</p>
<p>A use case scenario for <code>sortBy = "ctime"</code> is not
clear.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jonathan Callahan.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
